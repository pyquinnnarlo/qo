# enroll_finger.py
import time
import serial
import adafruit_fingerprint

# Setup Serial Connection for Pi 5
uart = serial.Serial("/dev/ttyS0", baudrate=57600, timeout=1)
finger = adafruit_fingerprint.Adafruit_Fingerprint(uart)

def enroll():
    print("---------------------------------------")
    print("   FINGERPRINT ENROLLMENT SYSTEM")
    print("---------------------------------------")
    
    if finger.read_templates() != adafruit_fingerprint.OK:
        print("Failed to read templates")
        return

    print(f"Current stored fingers: {finger.templates}")
    
    id_input = input("Enter ID # for this student (1-127): ")
    try:
        location = int(id_input)
    except ValueError:
        print("Invalid number.")
        return

    for i in range(1, 3):
        print(f"\nStep {i}/2: Place finger on sensor...")
        
        while finger.get_image() != adafruit_fingerprint.OK:
            pass # Wait for finger

        print("Image taken.")
        if finger.image_2_tz(i) != adafruit_fingerprint.OK:
            print("Imaging error")
            return
        
        print("Remove finger.")
        time.sleep(1)
        while finger.get_image() == adafruit_fingerprint.OK:
            pass # Wait for remove

    print("Creating model...")
    if finger.create_model() != adafruit_fingerprint.OK:
        print("Prints did not match!")
        return

    print(f"Storing model at #{location}...")
    if finger.store_model(location) != adafruit_fingerprint.OK:
        print("Error saving.")
        return

    print("Success! Finger enrolled.")

if __name__ == "__main__":
    enroll()
