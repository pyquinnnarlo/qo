# --- LOGIC LOOP (STRICT SECURITY MODE) ---
def exam_logic_loop():
    global current_detected_name
    
    time.sleep(3) 
    speak("Examination Proctor System Online.")
    
    while True:
        update_status("WAITING FOR STUDENT")
        
        # 1. Wait for a face
        if current_detected_name is None:
            if int(time.time()) % 10 == 0: 
                speak("Please step forward for identification.")
            time.sleep(1)
            continue
            
        # 2. Face Detected - STRICT CHECK
        name = current_detected_name
        update_status(f"IDENTIFYING: {name}")
        
        # --- SECURITY FIX: REJECT UNKNOWN FACES ---
        if name == "Unknown":
            speak("Face not recognized.")
            time.sleep(0.5)
            speak("Access Denied. Your face does not match our records.")
            speak("Please step aside and see a human administrator.")
            
            # Lock the system until this person leaves the camera view
            while current_detected_name is not None:
                time.sleep(1)
            continue # Restart loop for the next person
            
        # 3. Face is Known - Proceed to Verification
        speak(f"Biometric match found. Hello {name}.")
        
        # Retrieve Data
        student_data = get_student_info(name)
        
        if not student_data:
            # Face matches image file, but name isn't in JSON
            speak(f"Error. Student {name} has no registration data file.")
            while current_detected_name is not None: time.sleep(1)
            continue

        # 4. Two-Factor Authentication (Face + Voice ID)
        correct_id = student_data['id'].lower()
        spoken_id = listen("To confirm your identity, please state your Student I D.")
        
        # Check ID
        if spoken_id and clean_id(spoken_id) == clean_id(correct_id):
            speak("Identity confirmed.")
        else:
            speak(f"Authentication Failed. I heard {spoken_id}, but records expect {correct_id}.")
            speak("Access Denied.")
            while current_detected_name is not None: time.sleep(1)
            continue

        # 5. Ask for Test (Administrative Log)
        test_name = listen("What test are you writing today?")
        if test_name:
            speak(f"Logging entry for {test_name}.")
        
        # 6. Final Registration Check & Rules
        if student_data['registered']:
            speak("Registration Verified. Listen strictly to the rules.")
            time.sleep(0.3)
            speak("1. No electronic devices. Phones, watches, and glasses must be removed.")
            time.sleep(0.3)
            speak("2. Keep your eyes on your own paper.")
            time.sleep(0.3)
            speak("Violation will result in immediate failure.")
            time.sleep(0.5)
            speak("You may enter. Good luck.")
            
            # Wait for student to enter
            while current_detected_name is not None: time.sleep(1)
            speak("Next student.")
            
        else:
            speak(f"Alert. {name}, you are NOT registered for this exam.")
            speak("Please leave the area immediately.")
            while current_detected_name is not None: time.sleep(1)
